language: python
dist: focal
services:
    - xvfb
install:
    - make bin/chromedriver
before_script:
    # Runs only during the release process; Stops if CHANGELOG.md has the wrong format
    - make verify_changelog
after_script:
    - sleep 5 || true
    - make kill_windows_eyes_server || true
stages:
    - integration-tests
    - functional-tests
    - deploy
jobs:
    include:
        - stage: integration-tests
          os: windows
          language: sh
          before_install:
              - cp /c/ProgramData/chocolatey/bin/mingw32-make.exe /c/ProgramData/chocolatey/bin/make.exe
              - make install_windows_node install_windows_python_last
          script:
              - make test_integration
          env:
              - PATH="/c/Python310:/c/Python310/Scripts:/c/Program Files/Nodejs:$PATH"
          cache:
              directories:
                  - $LOCALAPPDATA/pip/Cache

        - os: windows
          language: sh
          before_install:
              - cp /c/ProgramData/chocolatey/bin/mingw32-make.exe /c/ProgramData/chocolatey/bin/make.exe
              - make install_windows_node install_windows_python2
          script:
              - make test_integration
          env:
              - PATH="/c/Python27:/c/Python27/Scripts:/c/Program Files/Nodejs:$PATH"
          cache:
              directories:
                  - $LOCALAPPDATA/pip/Cache

        - python: 2.7
          script:
              - make test_integration

        - python: 3.6
          script:
              - make test_integration

        - stage: functional-tests
          python: 3.6
          node_js: 16
          addons:
              chrome: stable
              firefox: latest
          env:
              - APPLITOOLS_BATCH_NAME="Python Coverage Tests"
          script:
              - nvm install --lts
              - make generated_tests
              - make send_cron_report

        - python: 3.10
          node_js: 16
          addons:
              chrome: stable
              firefox: latest
          env:
              - APPLITOOLS_BATCH_NAME="Python Coverage Tests"
          script:
              - nvm install --lts
              - make generated_tests
              - make send_cron_report

        - python: 3.6
          addons:
              chrome: stable
          script:
              - make robotframework_tests

        - python: 2.7
          addons:
              chrome: stable
          script:
              - make selenium_tests

        - python: 3.6
          addons:
              chrome: stable
              firefox: latest
          script:
              - make selenium_tests

        - python: 3.10
          addons:
              chrome: stable
              firefox: latest
          script:
              - make selenium_tests

        - os: windows
          language: sh
          python: 3.6
          before_install:
              - cp /c/ProgramData/chocolatey/bin/mingw32-make.exe /c/ProgramData/chocolatey/bin/make.exe
              - make install_windows_python_last install_windows_chrome
          script:
              - make selenium_tests
          env:
              - PATH="/c/Python310:/c/Python310/Scripts:/c/Program Files/Nodejs:$PATH"
          cache:
              directories:
                - $LOCALAPPDATA/pip/Cache

        - if: type = cron
          python: 3.6
          script:
            - make install_dev_requirements install_eyes_robotframework
            - bash ./tutorials/tutorials.sh

        - stage: deploy
          if: tag =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ AND fork == false
          python: 3.6
          script:
              # Deploy to PyPi and send notification about the tests execution status
              # The ALLOWED_RELEASE_COMMITERS, TWINE_USERNAME and TWINE_PASSWORD should be set in Travis CI settings
            - make send_relese_mail
            - make publish
